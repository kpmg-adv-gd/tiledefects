name: Deploy to Prd (Cloud Foundry)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: CI-CD-PRD

    steps:
      - name: ğŸ”„ Checkout codice
        uses: actions/checkout@v4

      - name: ğŸ§ª Installa dipendenze e lancia i test
        working-directory: ./defectstile  # â¬…ï¸ sostituisci con la cartella giusta
        run: |
          echo "ğŸ“¦ Installo dipendenze..."
          npm install
          echo "ğŸ§ª Eseguo test unitari..."
          # npm test

      - name: Usa manifest per ambiente Prd
        run: cp .staging/mta-prd.yaml mta.yaml


      - name: âš™ï¸ Installa MTA Build Tool (mbt)
        run: |
          echo "ğŸ“¦ Installo mbt..."
          npm install -g mbt
          mbt --version
 
      - name: ğŸ› ï¸ Eseguo build MTA
        run: |
          echo "ğŸ—ï¸ Avvio build MTA..."
          mbt build -p cf -t mta_archives
 
      - name: ğŸ”§ Installa cf CLI via dpkg
        run: |
          echo "ğŸ“¦ Scarico pacchetto Debian cf CLI..."
          curl -L "https://packages.cloudfoundry.org/stable?release=debian64" -o cf.deb
          sudo dpkg -i cf.deb
          cf version
 
      - name: ğŸ” Login su Cloud Foundry
        run: |
          set -e
          echo "ğŸŒ API endpoint: ${{ vars.CF_API }}"
          echo "ğŸ‘¤ Login con utente: ${{ vars.CF_USERNAME }}"
          cf login -a '${{ vars.CF_API }}' -u '${{ vars.CF_USERNAME }}' -p '${{ secrets.CF_PASSWORD }}' -o '${{ vars.CF_ORG }}' -s '${{ vars.CF_SPACE_DEV }}'
 
      - name: â• Installa plugin multiapps per MTA deploy
        run: |
          cf install-plugin -r CF-Community "multiapps" -f

      - name: ğŸš€ Deploy MTA su Cloud Foundry
        run: |
          cf deploy mta_archives/*.mtar -f